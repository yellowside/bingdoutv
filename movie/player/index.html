<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>正在播放 - 冰豆影视</title>
    <meta name="Keywords" content="热播电视剧,在线观看,蓝光电影,美剧,韩剧,超清电影" />
    <meta name="description" content="冰豆影视是一家免费全球影视资源在线观看的平台,拥有海量、优质、超清蓝光电影和全球的电视剧,高画质在线动漫。" />
    <link href="../../css/style.css" rel="stylesheet">
</head>
<body oncontextmenu="return false" onselectstart="return false">
    <header>
        <div class="header wrap">
            <h1 class="logo"><a href="../" title="冰豆影视">冰豆影视</a></h1>
            <div class="menu">
                <div class="menu-icon"></div>
                <div class="menu-container" id="menu"></div>
            </div>
        </div>
    </header>
    <main class="wrap"></main>
<footer id="foot"></footer>
<script src="https://cdnjs.misidao.cn/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
$('#menu').load('../../menu.html');
$('#foot').load('../../foot.html');
</script>
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const zy = urlParams.get('zy');
    const id = urlParams.get('id');

    // UTF-8 安全的 Base64 编码/解码函数
    function utf8ToBase64(str) {
        return btoa(unescape(encodeURIComponent(str)));
    }

    function base64ToUtf8(b64) {
        return decodeURIComponent(escape(atob(b64)));
    }

    // 请求数据
    fetch(`https://json.bingdou.cc/movie/?zy=${zy}&id=${id}`)
        .then(response => response.json())
        .then(data => {
            updatePageContent(data);
            initPlayer(data);
            createPlaylist(data);
            updateDescription(data);
        })
        .catch(error => console.error('Error:', error));

    // 更新页面内容
    function updatePageContent(data) {
        document.title = `正在播放${data.title} - 冰豆影视`;
        document.querySelector('meta[name="Keywords"]').content = `${data.title},热播电视剧,在线观看,蓝光电影,美剧,韩剧,超清电影`;
        
        const mainContent = `
            <section class="list wrap-inner">
                <div class="list-header">
                    <h3>正在播放-${data.title}</h3>
                </div>
                <div class="list-w list-box" style="margin-bottom:20px;margin-right:0">
                    <iframe name="player" id="playbox" allowfullscreen="true" frameborder="no" height="500" width="100%" scrolling="no"></iframe>
                </div>
            </section>
            <section class="list wrap-inner">
                <div class="list-header"><h3>播放列表</h3></div>
                <div class="list-w list-box playlist" id="playlist"></div>
            </section>
            <section class="list wrap-inner">
                <div class="list-header">
                    <h3>剧情介绍</h3>
                </div>
                <div class="list-text-box">
                    ${data.content || '暂无简介'}
                </div>
            </section>
            <section class="list wrap-inner">
                <div class="list-header">
                    <h3>免责声明</h3>
                </div>
                <div class="list-text-box">
                        <p>本站所有内容均自动搜索链接于互联网第三方网站页面，并不存储任何视频、音频资源。因此经由本站搜索所产生的任何结果皆不代表本站立场，本站不对其真实合法性以及版权负责，亦不承担任何法律责任。本站所有接口皆源于互联网，仅供学习交流。</p>
                </div>
            </section>
        `;
        
        document.querySelector('main').innerHTML = mainContent;
    }

    // 初始化播放器
    function initPlayer(data) {
        const firstPlayUrl = utf8ToBase64(data.data[0].play_url);  // 使用 UTF-8 安全 Base64 编码
        document.getElementById('playbox').src = 
            `https://player.misidao.cn/base64/?url=${firstPlayUrl}`;
    }

    // 创建播放列表
    function createPlaylist(data) {
        const playlist = document.getElementById('playlist');
        data.data.forEach((item, index) => {
            const li = document.createElement('li');
            const encodedUrl = utf8ToBase64(item.play_url);  // 使用 UTF-8 安全 Base64 编码
            li.innerHTML = `
                <a id="${index + 1}" href="https://player.misidao.cn/base64/?url=${encodedUrl}" 
                   title="${item.line}" target="player" 
                   onclick="handlePlaylistClick(${index + 1})">
                    ${item.line}
                </a>
            `;
            playlist.appendChild(li);
        });
    }

    // 点击事件处理
    let currentActive = 1;
    function handlePlaylistClick(id) {
        if (id === currentActive) return;
        
        const prevElement = document.getElementById(currentActive);
        const newElement = document.getElementById(id);
        
        prevElement.style.color = "orange";
        newElement.style.color = "red";
        currentActive = id;
    }

    // 可选：更新描述信息（原代码中没有实现，可保留或补充）
    function updateDescription(data) {
        // 示例：可在这里添加逻辑
    }
</script>
</body>
</html>
